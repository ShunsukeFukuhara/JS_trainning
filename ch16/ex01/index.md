## 問題

1. 用語「マルチスレッド」について調べなさい。

2. 次にフィボナッチ数を計算するmFib.jsをスレッド数を変更しながら実行し(*1)、コンソール出力とOS機能(*2)で結果とスレッド数を確認しなさい。
   *1 mFib.jsは第一引数で項数、第二引数でスレッド数を指定。コンソールには実行時間とフィボナッチ数が出力される。講師PCでは node mFib.js 45 4 の実行に15秒程かかる。
   *2 OSがwindowsの場合"リソースモニター"（"Winキー+r"の後"resmon"で起動）で実行中プログラムのスレッド数を確認できる。

3. 最後にあなたのPCのCPUスペックを調査し、適切なスレッド数についての考察を記しなさい。

## 解答

1. マルチスレッドとは、1つのプロセス内で複数のスレッドが同時に実行されることを指す。
   マルチスレッドでは、複数のスレッドが並行して動作することで、CPUのリソースを効率的に活用し、アプリケーションのパフォーマンスを向上させることができる。
   マルチスレッドの主な利点には以下のようなものがある：

- **計算時間の短縮**: 複数のスレッドが同時に処理を行うことで、多くの場合、全体の処理時間を短縮できる。なお、マルチスレッドによる性能向上は、処理が並列化可能であり、かつCPUやメモリなどのハードウェア資源に余裕がある場合に限られる。
- **応答性の向上**: ユーザーインターフェースが別のスレッドで動作することで、ユーザーの操作に対して迅速に応答できる。
- **リソースの効率的な利用**: I/O操作や待機時間が発生する場合でも、他のスレッドが処理を続行できるため、CPUのアイドル時間を減らすことができる。

ただし、マルチスレッドには以下のような課題も存在する：

- **同期の問題**: 複数のスレッドが同じリソースにアクセスする場合、データの整合性を保つために同期が必要となる。また、デッドロックや競合状態などによってバグが発生したり、計算時間が逆に増加したりすることがある。
- **環境依存性**: スレッドの動作は動作システムのCPUアーキテクチャやOSに依存するため、動作特性やパフォーマンスが異なる場合がある。そのため、マルチスレッドを有効に活用するため、必然的にシステム依存の調整や最適化が必要となることがある。
- **オーバーヘッド**: スレッドの管理やコンテキストスイッチングにはオーバーヘッドが伴い、スレッド数が増えると逆にパフォーマンスが低下することがある。

マルチスレッドを有効に活用するために、以下の点に注意することが重要である：

- 導入目的の明確化: マルチスレッドを導入する目的を明確にし、必要な場合にのみ使用する。
- 適切な同期機構の利用: ミューテックスやセマフォなどの同期機構を適切に利用し、データの整合性を保つ。
- システム依存性の考慮: 動作環境に応じた最適化を行い、パフォーマンスを最大化する。また、リリース時や更新時にパフォーマンスの再評価を行う。

2. mFib.jsを実行した結果、以下のような観察が得られた。
   なお、実験は私のPC（CPU: Intel Core i7-1265U、32GB RAM、Windows 11）で行った。実行時間は5回の平均値と標準偏差を示す。

フィボナッチ数42の場合:
スレッド数|resmon上のスレッド数|実行時間(秒)|
---|---|---|
1|17|4.7 ± 0.1|
2|18|3.1 ± 0.1|
4|20|2.8 ± 0.2|
8|24|2.6 ± 0.1|
12|28|2.6 ± 0.1|
16|32|2.6 ± 0.1|

フィボナッチ数45の場合:
スレッド数|resmon上のスレッド数|実行時間(秒)|
---|---|---|
1|17|21.0 ± 1.7|
2|18|15.1 ± 0.7|
4|20|12.2 ± 0.6|
8|24|11.1 ± 1.0|
12|28|11.3 ± 0.7|
16|32|11.2 ± 0.3|

フィボナッチ数48の場合:
スレッド数|resmon上のスレッド数|実行時間(秒)|
---|---|---|
1|17|93.4 ± 3.6|
2|18|62.8 ± 4.4|
4|20|48.8 ± 4.2|
8|24|46.0 ± 1.6|
12|28|48.1 ± 8.2|
16|32|50.7 ± 5.7|

フィボナッチ数計算をWeb Workerにより並列化したところ、スレッド数の増加に伴い実行時間は短縮された。
しかし、フィボナッチ数の大きさにかかわらず、スレッド数が8を超えると実行時間の短縮効果はほとんど見られなかった。
これはPCのCPUが8コア（実際は10コア）であるため、スレッド数がコア数を超えるとオーバーヘッドが増加し、パフォーマンス向上が頭打ちになるためと考えられる。
